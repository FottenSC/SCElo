(function(){"use strict";const B={rating:1500,rd:350,vol:.06},C=.5,T=173.7178;function F(e){return 1/Math.sqrt(1+3*e*e/(Math.PI*Math.PI))}function I(e,o,n){return 1/(1+Math.exp(-n*(e-o)))}function E(e){return{mu:(e.rating-1500)/T,phi:e.rd/T,sigma:e.vol}}function G(e,o,n){return{rating:e*T+1500,rd:o*T,vol:n}}function q(e,o,n=18.3){if(o<=0)return e;E(e);const a=Math.sqrt(e.rd*e.rd+n*n*o);return{...e,rd:Math.min(a,350)}}function N(e,o){if(o.length===0)return e;const{mu:n,phi:a,sigma:_}=E(e),s=1/o.reduce((c,d)=>{const M=E(d.opponent),m=F(M.phi),S=I(n,M.mu,m);return c+m*m*S*(1-S)},0),t=s*o.reduce((c,d)=>{const M=E(d.opponent),m=F(M.phi),S=I(n,M.mu,m);return c+m*(d.score-S)},0),i=Math.log(_*_),r=1e-6;let p=i,h;if(t*t>a*a+s)h=Math.log(Math.max(t*t-a*a-s,r));else{let c=1;const d=1e3;for(;R(i-c*C,t,a,s,i)<0&&c<d;)c++;if(c>=d)return e;h=i-c*C}let v=R(p,t,a,s,i),D=R(h,t,a,s,i),l=0;const u=100;for(;Math.abs(h-p)>r&&l<u;){const c=p+(p-h)*v/(D-v),d=R(c,t,a,s,i);d*D<0?(p=h,v=D):v/=2,h=c,D=d,l++}if(l>=u||!isFinite(p))return e;const g=Math.exp(p/2),w=Math.sqrt(a*a+g*g),f=1/Math.sqrt(1/(w*w)+1/s),A=n+f*f*o.reduce((c,d)=>{const M=E(d.opponent),m=F(M.phi),S=I(n,M.mu,m);return c+m*(d.score-S)},0),P=G(A,f,g);return!isFinite(P.rating)||!isFinite(P.rd)||!isFinite(P.vol)?e:P}function R(e,o,n,a,_){const y=Math.exp(e),s=y*(o*o-n*n-a-y),t=2*(n*n+a+y)*(n*n+a+y);return s/t-(e-_)/(C*C)}function L(){return{...B}}const x=self;x.onmessage=function(e){try{const{players:o,matches:n}=e.data,a=new Map;o.forEach(s=>{a.set(s.id,{...L(),id:s.id,matchCount:0})});const _=[];for(let s=0;s<n.length;s++){const t=n[s];if(!t)continue;if(s%10===0){const g={type:"progress",processedMatches:s};x.postMessage(g)}const i=a.get(t.player1_id),r=a.get(t.player2_id);if(!i||!r)continue;if(t.created_at){const g=new Date(t.created_at);if(i.lastMatchDate){const w=new Date(i.lastMatchDate),f=Math.floor((g.getTime()-w.getTime())/(1e3*60*60*24));if(f>0){const A=q(i,f);i.rd=A.rd}}if(r.lastMatchDate){const w=new Date(r.lastMatchDate),f=Math.floor((g.getTime()-w.getTime())/(1e3*60*60*24));if(f>0){const A=q(r,f);r.rd=A.rd}}}const p=t.winner_id===t.player1_id?1:0,h=t.winner_id===t.player2_id?1:0,v=i.rating,D=r.rating;let l,u;try{l=N(i,[{opponent:r,score:p}]),u=N(r,[{opponent:i,score:h}])}catch{continue}_.push({player_id:t.player1_id,match_id:t.id,event_type:"match",rating:l.rating,rd:l.rd,volatility:l.vol,rating_change:l.rating-v,opponent_id:t.player2_id,result:p}),_.push({player_id:t.player2_id,match_id:t.id,event_type:"match",rating:u.rating,rd:u.rd,volatility:u.vol,rating_change:u.rating-D,opponent_id:t.player1_id,result:h}),a.set(t.player1_id,{...l,id:t.player1_id,matchCount:i.matchCount+1,lastMatchDate:t.created_at||i.lastMatchDate}),a.set(t.player2_id,{...u,id:t.player2_id,matchCount:r.matchCount+1,lastMatchDate:t.created_at||r.lastMatchDate})}const y={type:"result",events:_};x.postMessage(y)}catch(o){const n={type:"error",error:o instanceof Error?o.message:String(o)};x.postMessage(n)}}})();
